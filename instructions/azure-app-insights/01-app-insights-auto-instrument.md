---
lab:
  topic: Application Insights
  title: 使用自動檢測監視應用程式
  description: '了解如何透過設定自動檢測來監視 Application Insights 中的應用程式，而不修改程式碼 '
---

# 使用自動檢測監視應用程式

在本練習中，您將建立已啟用 Application Insights 的 Azure App Service Web 應用程式、設定自動檢測而不修改程式碼、建立和部署 Blazor 應用程式，然後在 Application Insights 中檢視應用程式計量和錯誤資料。 實作全面的應用程式監控和可檢視性，而無需變更程式碼，讓部署和移轉更加容易。

在此練習中執行的工作：

* 建立已啟用 Application Insights 的 Web 應用程式資源
* 設定 Web 應用程式的檢測。
* 建立新 Blazor 應用程式，並部署至 Web 應用程式資源。
* 在 Application Insights 中檢視應用程式活動
* 清除資源

本練習大約需要 **20** 分鐘才能完成。

## 在 Azure 中建立資源

1. 在網頁瀏覽器中，瀏覽至 Azure 入口網站 [https://portal.azure.com](https://portal.azure.com)；若出現提示，請使用您的 Azure 認證登入。
1. 選取位於首頁頂端附近 [Azure 服務]**** 標題中的 [+ 建立資源]****。 
1. 在 [搜尋市集] **** 搜尋列中，輸入 *Web 應用程式*，然後按 **Enter** 鍵開始搜尋。
1. 在 [Web 應用程式磚] 中，選取 [建立]**** 下拉式清單，然後選取 [Web 應用程式]****。

    ![Web 應用程式磚的螢幕擷取畫面。](./media/create-web-app-tile.png)

選取 [建立]**** 會開啟一個範本，其中包含幾個索引標籤，可填寫有關您部署的資訊。 下列步驟會引導您完成在相關索引標籤中要進行的變更。

1. 在 [基本]**** 索引標籤中填寫下表中的資訊：

    | 設定 | 動作 |
    |--|--|
    | **訂用帳戶** | 保留預設值。 |
    | **資源群組** | 選取 [建立新項目]，輸入 `rg-WebApp`，然後選取 [確定]。 您也可以使用現有的資源群組 (若您偏好此做法)。 |
    | **名稱** | 輸入唯一名稱，例如 **YOUR-INITIALS-monitorapp**。 將 **YOUR-INITIALS** 取代為您的姓名首字母縮寫，或其他值。 名稱必須是獨一無二的，因此可能需要進行一些變更。 |
    | [名稱]**** 設定下的滑桿 | 選取滑桿以將其關閉。 此滑桿只會出現在某些 Azure 設定中。 |
    | **發行** | 選取 [程式碼]**** 選項。 |
    | **執行階段堆疊** | 在下拉式功能表中，選取 [.NET 8 (LTS)]****。 |
    | **作業系統** | 選取 [Windows]****。 |
    | **區域** | 保留預設選項，或選擇您附近的地區。 |
    | **Windows Plan** | 保留預設選項。 |
    | **定價方案** | 選取下拉式清單，然後選擇 [免費 F1]**** 方案。 |

1. 選取或瀏覽至 [監視器 + 安全]**** 索引標籤，然後輸入下表中的資訊：

    | 設定 | 動作 |
    |--|--|
    | **啟用 Application Insights** | 選取 [是]****。 |
    | **Application Insights** | 選取 [建立新項目]****，對話方塊隨即出現。 在對話方塊的 [名稱]**** 欄位中輸入 `autoinstrument-insights`。 然後選取 [確定]**** 以接受名稱。 |
    | **工作區** | 如果欄位尚未填寫並鎖定，請輸入 `Workspace`。 |

1. 選取 [檢閱 + 建立]**** 以檢閱警示部署的詳細資料。 選取 [建立]**** 以建立資源。

需要幾分鐘的時間才能完成部署。 完成後，請選取 [前往資源] **** 按鈕。

### 設定檢測設定

若要在不變更程式碼的情況下啟用監控，您必須在服務層級設定應用程式的檢測。

1. 在左側導覽功能表中，展開 [監視]****，然後選取 [Application Insights]****。

1. 找到 [檢測您的應用程式]**** 區段，然後選取 [.NET Core]****。

1. 在 [集合層級]**** 區段中，選取 [推薦項目]****。

1. 選取 [套用]****，然後確認變更。

1. 在左側導覽功能表中，選取 [概觀]****。

## 建立和部署 Blazor 應用程式

在本練習的此章節中，您將在 Cloud Shell 中建立 Blazor 應用程式，並部署到您建立的網頁應用程式。 本章節的所有步驟是在 Cloud Shell 中執行。

1. 使用頁面上方搜尋欄右側的 **[\>_]** 按鈕，就能從 Azure 入口網站建立新的 Cloud Shell，並選取 ***Bash*** 環境。 Cloud Shell 會在 Azure 入口網站底部的窗格顯示命令列介面。 如果系統提示您選取儲存體帳戶以保存檔案，請選取 [不需要儲存體帳戶]****、[您的訂用帳戶]，然後選取 [套用]****。

    > **備註**：如果您之前就已建立使用 *Bash* 環境的 Cloud Shell，請將原先的設定切換成 ***PowerShell***。

1. 執行下列命令，為 Blazor 應用程式建立目錄，並變更為目錄。

    ```
    mkdir blazor
    cd blazor
    ```

1. 執行下列命令，在資料夾中建立新 Blazor 應用程式。

    ```
    dotnet new blazor
    ```

1. 執行下列命令來建置應用程式，以確保建立期間沒有問題。

    ```
    dotnet build
    ```

### 將應用程式部署至 App Service

若要部署應用程式，您必須先使用 **dotnet publish** 命令發佈應用程式，然後建立要部署的 *.zip* 檔案。

1. 執行下列命令，將應用程式發佈至*發佈*目錄。

    ```
    dotnet publish -c Release -o ./publish
    ```

1. 執行下列命令以建立已發佈應用程式的 *.zip* 檔案。 *.zip*檔案將位於應用程式的根目錄中。

    ```
    cd publish
    zip -r ../app.zip .
    cd ..
    ```

1. 執行下列命令，將應用程式部署至 App Service。 將 **YOUR-WEB-APP-NAME** 和 **YOUR-RESOURCE-GROUP** 取代為您先前在練習中建立 App Service 資源時所使用的值。

    ```
    az webapp deploy --name YOUR-WEB-APP-NAME \
        --resource-group YOUR-RESOURCE-GROUP \
        --src-path ./app.zip
    ```

1. 部署完成後，在 [基本功能]**** 區段中，選取 [預設網域]**** 欄位中的連結，以在瀏覽器的新索引標籤中開啟應用程式。

現在您可以在 Application Insights 中查看一些基本應用程式計量。 請勿關閉此索引標籤，在接下來的練習中會需要使用。

## 在 Application Insights 中檢視計量

返回 Azure 入口網站的索引標籤，並瀏覽至您先前建立的 Application Insights 資源。 **概觀** 索引標籤會顯示一些基本圖表：

* 失敗的要求
* 伺服器回應時間
* 伺服器要求
* 可用性

在本節中，您將在 Web 應用程式中執行一些動作，然後返回此頁面檢視活動。 活動報告已延遲，因此可能需要幾分鐘的時間才能顯示在圖表中。

執行 Web 應用程式中的下列步驟。

1. 在 Web 應用程式功能表中的 [首頁]****、[+ 計數器]**** 和 [天氣] **** 導覽選項之間瀏覽。

1. 重新整理網頁數次，以產生**伺服器回應時間**和**伺服器要求**資料。

1. 若要建立一些錯誤，請選取 [首頁]**** 按鈕，然後在 URL 中附加 **/failures**。 此路由不存在於 Web 應用程式中，且會產生錯誤。 重新整理頁面數次以產生錯誤資料。

1. 返回執行 Application Insights 的索引標籤，然後等候一兩分鐘，讓資訊顯示在圖表中。 

1. 在左側導覽中，展開 [調查] **** 區段，然後選取 [失敗]****。 此處會顯示失敗要求的數量，以及更多失敗回應碼的詳細資訊。

探索其他報告選項，了解其他可用類型的資訊。 

## 清除資源

現在您已完成練習，您應該刪除建立的雲端資源，以避免不必要的資源使用狀況。

1. 瀏覽至您建立的資源群組，並檢視此練習中所使用的資源內容。
1. 在工具列上，選取 [刪除資源群組]****。
1. 輸入資源群組名稱並確認您想要將其刪除。

> **注意：** 刪除資源群組時，會刪除其中包含的所有資源。 如果您選擇此練習的現有資源群組，則本練習範圍外的任何現有資源也將遭到刪除。
